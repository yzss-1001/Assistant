<!-- templates/camera_app/index.html -->
{% extends "base.html" %}

{% block title %}æ‘„åƒå¤´ç›‘æ§ - Django{% endblock %}

{% block content %}
<div class="status-bar">
    <div>
        <strong>æ‘„åƒå¤´çŠ¶æ€:</strong>
        <span class="status-indicator">
            <span id="statusDot" class="status-dot"></span>
            <span id="statusText">æœªè¿æ¥</span>
        </span>
    </div>
    <div id="connectionInfo">
        <strong>å¸§ç‡:</strong> <span id="fpsCounter">0</span> FPS
    </div>
    <!-- æ£€æµ‹çŠ¶æ€æ˜¾ç¤º -->
    <div id="detectionInfo">
        <strong>ç›®æ ‡æ£€æµ‹:</strong> 
        <span id="detectionStatusText">æœªå¼€å¯</span>
    </div>
    <!-- æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜çŠ¶æ€æ˜¾ç¤º -->
    <div id="autoSaveInfo">
        <strong>è‡ªåŠ¨ä¿å­˜:</strong> 
        <span id="autoSaveStatusText">æœªå¼€å¯</span>
    </div>
</div>

<div class="video-container">
    <img id="videoFeed" src="{% url 'video_feed' %}" alt="å®æ—¶è§†é¢‘æµ" style="display: none;">
    <div id="videoPlaceholder" class="video-placeholder">
        <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“·</div>
            <div>æ‘„åƒå¤´æœªå¯åŠ¨</div>
            <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"å¼€å§‹ç›‘æ§</div>
        </div>
    </div>
</div>

<div class="controls">
    <button id="startBtn" class="btn btn-start" onclick="startCamera()">
        <span>â–¶</span> å¯åŠ¨æ‘„åƒå¤´
    </button>
    <button id="stopBtn" class="btn btn-stop" onclick="stopCamera()" disabled>
        <span>â¹</span> åœæ­¢æ‘„åƒå¤´
    </button>
    <button id="snapshotBtn" class="btn btn-snapshot" onclick="takeSnapshot()" disabled>
        <span>ğŸ“¸</span> æ‹æ‘„å¿«ç…§
    </button>
    <!-- ç›®æ ‡æ£€æµ‹æ§åˆ¶æŒ‰é’® -->
    <button id="toggleDetection" class="btn btn-warning" onclick="toggleDetection()" disabled>
        <span>ğŸ”</span> å¼€å¯
    </button>
    <button id="detectionStatusBtn" class="btn btn-info" onclick="checkDetectionStatus()" disabled>
        <span>â„¹ï¸</span> æ£€æµ‹çŠ¶æ€
    </button>
    <!-- æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜æ§åˆ¶æŒ‰é’® -->
    <button id="toggleAutoSave" class="btn btn-success" onclick="toggleAutoSave()" disabled>
        <span>ğŸ’¾</span> å¼€å¯è‡ªåŠ¨ä¿å­˜
    </button>
    <button id="fullscreenBtn" class="btn btn-fullscreen" onclick="toggleFullscreen()">
        <span>â›¶</span> å…¨å±æ˜¾ç¤º
    </button>
</div>

<!-- æ£€æµ‹æ§åˆ¶é¢æ¿ -->
<div class="control-panel" id="controlPanel" style="display: none;">
    <h3>âš™ï¸ æ£€æµ‹è®¾ç½®</h3>
    <div class="panel-content">
        <div class="setting-group">
            <label for="saveInterval">ä¿å­˜é—´éš”:</label>
            <input type="number" id="saveInterval" value="2" min="1" max="10" class="interval-input">
            <span>ç§’</span>
            <button class="btn btn-small" onclick="setSaveInterval()">åº”ç”¨</button>
        </div>
        <div class="stats-group">
            <div class="stat-item">
                <strong>æ£€æµ‹è®¡æ•°:</strong> <span id="detectionCount">0</span>
            </div>
            <div class="stat-item">
                <strong>å·²ä¿å­˜å›¾ç‰‡:</strong> <span id="savedCount">0</span>
            </div>
            <div class="stat-item">
                <strong>æ¨¡å‹çŠ¶æ€:</strong> <span id="modelStatus">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
</div>

<!-- æ£€æµ‹ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
<div class="detection-results" id="detectionResults" style="display: none;">
    <h3>ğŸ¯ å®æ—¶æ£€æµ‹ç»“æœ</h3>
    <div id="detectionInfoContainer">
        <div class="detection-stats">
            <div>æ£€æµ‹å¯¹è±¡: <span id="detectedObjects">0</span></div>
            <div>ç½®ä¿¡åº¦: <span id="detectionConfidence">0%</span></div>
            <div>è‡ªåŠ¨ä¿å­˜: <span id="autoSaveIndicator">âŒ</span></div>
        </div>
    </div>
</div>

<div class="snapshots">
    <h3>ğŸ“ å¿«ç…§è®°å½•</h3>
    <div id="snapshotContainer">
        <!-- å¿«ç…§å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
    </div>
</div>

<!-- æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜å›¾ç‰‡åŒºåŸŸ -->
<div class="saved-images">
    <h3>ğŸ–¼ï¸ è‡ªåŠ¨ä¿å­˜çš„æ£€æµ‹å›¾ç‰‡</h3>
    <div class="saved-header">
        <div class="saved-stats">
            å…± <span id="totalSavedCount">0</span> å¼ å›¾ç‰‡
            <button class="btn btn-small" onclick="refreshSavedImages()">ğŸ”„ åˆ·æ–°</button>
            <button class="btn btn-small btn-danger" onclick="clearAllSavedImages()" style="display: none;">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨</button>
        </div>
    </div>
    <div id="savedImagesContainer" class="saved-images-container">
        <!-- è‡ªåŠ¨ä¿å­˜çš„å›¾ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isCameraRunning = false;
    let isDetectionEnabled = false;
    let isAutoSaveEnabled = false;
    let frameCount = 0;
    let fps = 0;
    let lastTime = Date.now();
    let snapshotKeys = new Set();

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(isRunning, hasFrame = false) {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const videoFeed = document.getElementById('videoFeed');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const snapshotBtn = document.getElementById('snapshotBtn');
        const toggleDetectionBtn = document.getElementById('toggleDetection');
        const detectionStatusBtn = document.getElementById('detectionStatusBtn');
        const toggleAutoSaveBtn = document.getElementById('toggleAutoSave');
        const controlPanel = document.getElementById('controlPanel');

        isCameraRunning = isRunning;

        if (isRunning) {
            statusDot.className = 'status-dot active';
            statusText.textContent = hasFrame ? 'è¿è¡Œä¸­' : 'è¿æ¥ä¸­...';
            videoFeed.style.display = hasFrame ? 'block' : 'none';
            videoPlaceholder.style.display = hasFrame ? 'none' : 'flex';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            snapshotBtn.disabled = !hasFrame;
            toggleDetectionBtn.disabled = !hasFrame;
            detectionStatusBtn.disabled = !hasFrame;
            toggleAutoSaveBtn.disabled = !hasFrame;
            
            // æ˜¾ç¤ºæ§åˆ¶é¢æ¿
            if (hasFrame) {
                controlPanel.style.display = 'block';
            }
        } else {
            statusDot.className = 'status-dot';
            statusText.textContent = 'æœªè¿æ¥';
            videoFeed.style.display = 'none';
            videoPlaceholder.style.display = 'flex';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            snapshotBtn.disabled = true;
            toggleDetectionBtn.disabled = true;
            detectionStatusBtn.disabled = true;
            toggleAutoSaveBtn.disabled = true;
            controlPanel.style.display = 'none';
        }
    }

    // å¯åŠ¨æ‘„åƒå¤´
    async function startCamera() {
        try {
            updateStatus(true, false);

            const response = await fetch('{% url "start_camera" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ camera_index: 0 })
            });

            const data = await response.json();

            if (data.status === 'success') {
                showToast('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');
                // å¼€å§‹æ£€æŸ¥çŠ¶æ€
                checkCameraStatus();
                // æ£€æŸ¥æ£€æµ‹çŠ¶æ€
                checkDetectionStatus();
                // åŠ è½½å·²ä¿å­˜çš„å›¾ç‰‡
                loadSavedImages();
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('å¯åŠ¨æ‘„åƒå¤´å¤±è´¥:', error);
            showToast('å¯åŠ¨å¤±è´¥: ' + error.message, true);
            updateStatus(false);
        }
    }

    // åœæ­¢æ‘„åƒå¤´
    async function stopCamera() {
        try {
            const response = await fetch('{% url "stop_camera" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.status === 'success') {
                showToast('æ‘„åƒå¤´å·²åœæ­¢');
                updateStatus(false);
                // é‡ç½®æ£€æµ‹çŠ¶æ€
                isDetectionEnabled = false;
                isAutoSaveEnabled = false;
                updateDetectionStatus(false);
                updateAutoSaveStatus(false);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            // console.error('åœæ­¢æ‘„åƒå¤´å¤±è´¥:', error);
            // showToast('åœæ­¢å¤±è´¥: ' + error.message, true);
        }
    }

    // æ‹æ‘„å¿«ç…§
    async function takeSnapshot() {
        try {
            const response = await fetch('{% url "take_snapshot" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.status === 'success') {
                showToast('å¿«ç…§æ‹æ‘„æˆåŠŸ');
                addSnapshot(data.snapshot_key);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('æ‹æ‘„å¿«ç…§å¤±è´¥:', error);
            showToast('æ‹æ‘„å¤±è´¥: ' + error.message, true);
        }
    }

    // åˆ‡æ¢ç›®æ ‡æ£€æµ‹
    async function toggleDetection() {
        try {
            const response = await fetch('{% url "toggle_detection" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.status === 'success') {
                isDetectionEnabled = data.detection_enabled;
                updateDetectionStatus(isDetectionEnabled);
                showToast(data.message);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            // console.error('åˆ‡æ¢æ£€æµ‹å¤±è´¥:', error);
            // showToast('æ“ä½œå¤±è´¥: ' + error.message, true);
        }
    }

    // åˆ‡æ¢è‡ªåŠ¨ä¿å­˜
    async function toggleAutoSave() {
        try {
            const response = await fetch('{% url "toggle_auto_save" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();

            if (data.status === 'success') {
                isAutoSaveEnabled = data.auto_save_enabled;
                updateAutoSaveStatus(isAutoSaveEnabled);
                showToast(data.message);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            // console.error('åˆ‡æ¢è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            // showToast('æ“ä½œå¤±è´¥: ' + error.message, true);
        }
    }

    // è®¾ç½®ä¿å­˜é—´éš”
    async function setSaveInterval() {
        try {
            const intervalInput = document.getElementById('saveInterval');
            const interval = parseInt(intervalInput.value);
            
            if (interval < 1 || interval > 10) {
                showToast('ä¿å­˜é—´éš”å¿…é¡»åœ¨1-10ç§’ä¹‹é—´', true);
                return;
            }

            const response = await fetch('{% url "set_save_interval" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ interval: interval })
            });

            const data = await response.json();

            if (data.status === 'success') {
                showToast(data.message);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('è®¾ç½®ä¿å­˜é—´éš”å¤±è´¥:', error);
            showToast('è®¾ç½®å¤±è´¥: ' + error.message, true);
        }
    }

    // æ£€æŸ¥æ£€æµ‹çŠ¶æ€
    async function checkDetectionStatus() {
        try {
            const response = await fetch('{% url "get_detection_info" %}');
            const data = await response.json();

            if (data.status === 'success') {
                const info = data.data;
                isDetectionEnabled = info.detection_enabled;
                isAutoSaveEnabled = info.auto_save_enabled;
                
                updateDetectionStatus(isDetectionEnabled);
                updateAutoSaveStatus(isAutoSaveEnabled);
                updateDetectionInfo(info);
                
                if (!info.model_loaded) {
                    showToast('YOLOv10æ¨¡å‹åŠ è½½å¤±è´¥', true);
                }
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            // console.error('è·å–æ£€æµ‹çŠ¶æ€å¤±è´¥:', error);
        }
    }

    // æ›´æ–°æ£€æµ‹çŠ¶æ€æ˜¾ç¤º
    function updateDetectionStatus(enabled) {
        const toggleDetectionBtn = document.getElementById('toggleDetection');
        const detectionStatusText = document.getElementById('detectionStatusText');
        const detectionResults = document.getElementById('detectionResults');

        if (enabled) {
            toggleDetectionBtn.innerHTML = '<span>ğŸ”</span> å…³é—­ç›®æ ‡æ£€æµ‹';
            toggleDetectionBtn.className = 'btn btn-warning active';
            detectionStatusText.textContent = 'å·²å¼€å¯';
            detectionStatusText.style.color = '#28a745';
            detectionResults.style.display = 'block';
        } else {
            toggleDetectionBtn.innerHTML = '<span>ğŸ”</span> å¼€å¯ç›®æ ‡æ£€æµ‹';
            toggleDetectionBtn.className = 'btn btn-warning';
            detectionStatusText.textContent = 'æœªå¼€å¯';
            detectionStatusText.style.color = '#6c757d';
            detectionResults.style.display = 'none';
        }
    }

    // æ›´æ–°è‡ªåŠ¨ä¿å­˜çŠ¶æ€æ˜¾ç¤º
    function updateAutoSaveStatus(enabled) {
        const toggleAutoSaveBtn = document.getElementById('toggleAutoSave');
        const autoSaveStatusText = document.getElementById('autoSaveStatusText');
        const autoSaveIndicator = document.getElementById('autoSaveIndicator');

        if (enabled) {
            toggleAutoSaveBtn.innerHTML = '<span>ğŸ’¾</span> å…³é—­è‡ªåŠ¨ä¿å­˜';
            toggleAutoSaveBtn.className = 'btn btn-success active';
            autoSaveStatusText.textContent = 'å·²å¼€å¯';
            autoSaveStatusText.style.color = '#28a745';
            autoSaveIndicator.textContent = 'âœ…';
        } else {
            toggleAutoSaveBtn.innerHTML = '<span>ğŸ’¾</span> å¼€å¯è‡ªåŠ¨ä¿å­˜';
            toggleAutoSaveBtn.className = 'btn btn-success';
            autoSaveStatusText.textContent = 'æœªå¼€å¯';
            autoSaveStatusText.style.color = '#6c757d';
            autoSaveIndicator.textContent = 'âŒ';
        }
    }

    // æ›´æ–°æ£€æµ‹ä¿¡æ¯
    function updateDetectionInfo(info) {
        document.getElementById('detectionCount').textContent = info.detection_count || 0;
        document.getElementById('savedCount').textContent = info.saved_images_count || 0;
        document.getElementById('totalSavedCount').textContent = info.saved_images_count || 0;
        document.getElementById('modelStatus').textContent = info.model_loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½';
        document.getElementById('saveInterval').value = info.save_interval || 2;
    }

    // åŠ è½½å·²ä¿å­˜çš„å›¾ç‰‡
    async function loadSavedImages() {
        try {
            const response = await fetch('{% url "get_detection_info" %}');
            const data = await response.json();

            if (data.status === 'success') {
                updateDetectionInfo(data.data);
                // è¿™é‡Œå¯ä»¥æ·»åŠ åŠ è½½å…·ä½“å›¾ç‰‡åˆ—è¡¨çš„åŠŸèƒ½
                // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦ä¸€ä¸ªä¸“é—¨çš„APIæ¥è·å–ä¿å­˜çš„å›¾ç‰‡åˆ—è¡¨
            }
        } catch (error) {
            console.error('åŠ è½½ä¿å­˜çš„å›¾ç‰‡å¤±è´¥:', error);
        }
    }

    // åˆ·æ–°ä¿å­˜çš„å›¾ç‰‡
    function refreshSavedImages() {
        loadSavedImages();
        showToast('å·²åˆ·æ–°å›¾ç‰‡åˆ—è¡¨');
    }

    // æ¸…ç©ºæ‰€æœ‰ä¿å­˜çš„å›¾ç‰‡
    async function clearAllSavedImages() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è‡ªåŠ¨ä¿å­˜çš„å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            return;
        }

        try {
            // è¿™é‡Œéœ€è¦å®ç°æ¸…ç©ºå›¾ç‰‡çš„åç«¯API
            // æš‚æ—¶æ˜¾ç¤ºæç¤º
            showToast('æ¸…ç©ºåŠŸèƒ½å¼€å‘ä¸­...');
        } catch (error) {
            console.error('æ¸…ç©ºå›¾ç‰‡å¤±è´¥:', error);
            showToast('æ¸…ç©ºå¤±è´¥: ' + error.message, true);
        }
    }

    // æ·»åŠ å¿«ç…§åˆ°ç•Œé¢
    function addSnapshot(snapshotKey) {
        if (snapshotKeys.has(snapshotKey)) return;

        snapshotKeys.add(snapshotKey);

        const snapshotUrl = `{% url 'get_snapshot' '0' %}`.replace('0', snapshotKey);
        const timestamp = new Date().toLocaleString();

        const snapshotItem = document.createElement('div');
        snapshotItem.className = 'snapshot-item';
        snapshotItem.innerHTML = `
            <img src="${snapshotUrl}" alt="å¿«ç…§ ${timestamp}" loading="lazy">
            <div class="snapshot-info">
                <div class="snapshot-time">${timestamp}</div>
                ${isDetectionEnabled ? '<div class="detection-badge">AIæ£€æµ‹</div>' : ''}
            </div>
            <div class="snapshot-actions">
                <button class="snapshot-btn" onclick="downloadSnapshot('${snapshotKey}')" title="ä¸‹è½½">ğŸ’¾</button>
                <button class="snapshot-btn" onclick="deleteSnapshot(this, '${snapshotKey}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </div>
        `;

        document.getElementById('snapshotContainer').prepend(snapshotItem);
    }

    // ä¸‹è½½å¿«ç…§
    function downloadSnapshot(snapshotKey) {
        const link = document.createElement('a');
        link.href = `{% url 'get_snapshot' '0' %}`.replace('0', snapshotKey);
        link.download = `snapshot_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // åˆ é™¤å¿«ç…§
    function deleteSnapshot(button, snapshotKey) {
        const snapshotItem = button.closest('.snapshot-item');
        snapshotItem.remove();
        snapshotKeys.delete(snapshotKey);
    }

    // å…¨å±æ˜¾ç¤º
    function toggleFullscreen() {
        const videoContainer = document.querySelector('.video-container');

        if (!document.fullscreenElement) {
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    // æ£€æŸ¥æ‘„åƒå¤´çŠ¶æ€
    async function checkCameraStatus() {
        if (!isCameraRunning) return;

        try {
            const response = await fetch('{% url "camera_status" %}');
            const status = await response.json();

            updateStatus(true, status.has_frame);

            // è®¡ç®— FPS
            frameCount++;
            const currentTime = Date.now();
            if (currentTime - lastTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastTime = currentTime;
                document.getElementById('fpsCounter').textContent = fps;
            }

            // å®šæœŸæ›´æ–°æ£€æµ‹ä¿¡æ¯
            if (frameCount % 30 === 0) { // æ¯30å¸§æ›´æ–°ä¸€æ¬¡
                checkDetectionStatus();
            }

            // ç»§ç»­æ£€æŸ¥çŠ¶æ€
            setTimeout(checkCameraStatus, 1000);
        } catch (error) {
            console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
            updateStatus(false);
        }
    }

    // è·å– CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // è§†é¢‘æµé”™è¯¯å¤„ç†
    document.getElementById('videoFeed').onerror = function() {
        if (isCameraRunning) {
            showToast('è§†é¢‘æµåŠ è½½å¤±è´¥', true);
            updateStatus(true, false);
        }
    };

    document.getElementById('videoFeed').onload = function() {
        if (isCameraRunning) {
            updateStatus(true, true);
        }
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        updateStatus(false);
        // åˆå§‹æ£€æŸ¥çŠ¶æ€
        checkCameraStatus();
    });

    // æ˜¾ç¤ºToastæ¶ˆæ¯
    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: ${isError ? '#dc3545' : '#28a745'};
            color: white;
            border-radius: 5px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }
</script>

<style>
    /* æ–°å¢æ ·å¼ */
    .btn-warning {
        background: #ffc107;
        color: #212529;
        border: 1px solid #ffc107;
    }
    
    .btn-warning:hover {
        background: #e0a800;
        border-color: #e0a800;
    }
    
    .btn-warning.active {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }
    
    .btn-info {
        background: #17a2b8;
        color: white;
        border: 1px solid #17a2b8;
    }
    
    .btn-info:hover {
        background: #138496;
        border-color: #138496;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
        border: 1px solid #28a745;
    }
    
    .btn-success:hover {
        background: #218838;
        border-color: #218838;
    }
    
    .btn-success.active {
        background: #dc3545;
        color: white;
        border-color: #dc3545;
    }
    
    .btn-small {
        padding: 4px 8px;
        font-size: 12px;
        margin-left: 5px;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
        border: 1px solid #dc3545;
    }
    
    .btn-danger:hover {
        background: #c82333;
        border-color: #c82333;
    }
    
    .control-panel {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
    }
    
    .panel-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .setting-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .interval-input {
        width: 60px;
        padding: 4px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        text-align: center;
    }
    
    .stats-group {
        display: flex;
        gap: 15px;
    }
    
    .stat-item {
        padding: 5px 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        font-size: 14px;
    }
    
    .detection-results {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
    }
    
    .detection-stats {
        display: flex;
        gap: 20px;
        font-size: 14px;
    }
    
    .detection-stats div {
        padding: 5px 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }
    
    .snapshot-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
    }
    
    .detection-badge {
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
    }
    
    .saved-images {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .saved-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .saved-stats {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
    }
    
    .saved-images-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
    
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .panel-content {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .stats-group {
            flex-wrap: wrap;
        }
        
        .detection-stats {
            flex-direction: column;
            gap: 10px;
        }
        
        .controls {
            flex-wrap: wrap;
        }
        
        .controls .btn {
            flex: 1 1 45%;
            margin: 5px;
        }
    }
</style>
{% endblock %}